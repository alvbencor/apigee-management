<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario de APIs</title>
  <style>
    body {
      font-family: monospace;
      margin: 2rem auto;
      width: 80%;
      background-color: #3e5248;
      color: beige;
    }
    h1 { font-family: sans-serif; color: beige; }
    /* Zona de carga */
    .file-loading { display: flex; gap: 1rem; align-items: flex-start; margin-bottom: 1rem; }
    .dropzone {
      border: 2px dashed #afe2b1;
      width: 17rem;
      height: calc(2.5rem * 2 + 0.5rem);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #afe2b1;
      cursor: pointer;
    }
    .dropzone.hover { background-color: #52675b; }
    .url-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .url-group input, .url-group button { height: 2.5rem; padding: 0 0.5rem; border: none; border-radius: 4px; font-family: monospace; }
    .url-group input { background: #52675b; color: beige; width: 17rem; }
    .url-group button { background: #85ecb2; color: #3c3f3f; cursor: pointer; }
    /* Oculto inicialmente excepto zona de carga */
    #stats, .loaded-message, .search-filter, #filterToggle, #filterOptions, #actionsGroup, #resultCount, .table-container {
      display: none;
    }
    #stats, #resultCount { margin: 1rem 0; font-size: 1rem; }
    .search-filter { display: flex; align-items: center; gap: 1rem; margin: 1rem 0; }
    #searchGroup input { width: 100%; max-width: 30rem; padding: 0.5rem; border: none; border-radius: 4px; background: #52675b; color: beige; }
    #search{display: none;}
    .filter-toggle { cursor: pointer; font-family: monospace; }
    .filter-toggle span { user-select: none; color: #fbf3a3; }
    #filterOptions { margin: 1rem 0; font-family: monospace; }
    #filterOptions .radios, #filterOptions .checkboxes { margin: 0.5rem 0; }
    #filterOptions label { margin-right: 1rem; }
    #loadedName { color: #85ecb2; }
    #loadedMessage { color: #5d9c79; }
    .actions { display: flex; gap: 1rem; margin: 1rem 0; }
    .actions button { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-family: monospace; }
    .copy-btn { background-color: #fbf3a3; color: #3c3f3f; }
    .export-btn { background-color: #abfbb0; color: #3c3f3f; }
    #toggleArrow{margin-left: 1rem;}
    /* Tabla */
    .table-container { max-width: 80vw; margin: 0 auto 2rem; overflow: auto; max-height: calc(100vh - 20rem); }
    table { table-layout: fixed; width: 100%; border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc;
      padding: 0.3rem;
      text-align: left;
      font-family: monospace;
      max-width: 15vw;
      word-wrap: break-word;
      word-break: break-all;
      overflow: hidden;
    }
    th {
      background-color: #afe2b1;
      color: #3c3f3f;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tr:nth-child(even) { background-color: #52675b; }
  </style>
</head>
<body>
  <h1>Inventario de APIs</h1>
  <!-- Zona de carga inicial -->
  <div class="file-loading" id="fileLoading">
    <div class="dropzone" id="dropzone">Arrastra tu CSV o haz clic</div>
    <div class="url-group" id="urlGroup">
      <input type="text" id="urlInput" placeholder="Introduce URL o ruta local">
      <button id="loadUrlBtn">Cargar inventario</button>
    </div>
  </div>
  <div id="stats"></div>
  <div class="loaded-message" id="loadedMessage">✓ Archivo cargado: <span id="loadedName"></span></div>
  <input type="file" id="fileInput" accept=".csv" style="display:none">
  <!-- Búsqueda y filtros -->
  <div class="search-filter">
    <div id="searchGroup"><input id="search" type="text" placeholder="Escribe para filtrar..."></div>
    <div class="filter-toggle" id="filterToggle"><span id="toggleArrow">▸</span> <span id="toggleText">Mostrar filtros</span></div>
  </div>
  <div id="filterOptions">
    <div class="radios">
      <label><input type="radio" name="mode" value="all" checked> Todo</label>
      <label><input type="radio" name="mode" value="prodSinApp"> Sólo productos sin app</label>
      <label><input type="radio" name="mode" value="proxySinProd"> Sólo proxies sin producto</label>
    </div>
    <div class="checkboxes">
      <label><input type="checkbox" id="chkApp" checked /> Apps</label>
      <label><input type="checkbox" id="chkDev" checked /> Developers</label>
      <label><input type="checkbox" id="chkProd" checked /> Productos</label>
      <label><input type="checkbox" id="chkProxy" checked /> Proxies</label>
      <label><input type="checkbox" id="chkKVM" checked /> KVM</label>
      <label><input type="checkbox" id="chkTarget" checked /> Targets</label>
    </div>
  </div>
  <!-- Acciones -->
  <div id="actionsGroup" class="actions">
    <button class="copy-btn" id="copyBtn">Copiar tabla</button>
    <button class="export-btn" id="exportBtn">Exportar a CSV</button>
  </div>
  <div id="resultCount">Total resultados: <span id="countNumber">0</span></div>
  <!-- Tabla -->
  <div class="table-container">
    <table id="inventoryTable">
      <thead><tr id="headerRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    let data = [], filtered = [], isDefault = false;
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const urlInput = document.getElementById('urlInput');
    const loadUrlBtn = document.getElementById('loadUrlBtn');
    const fileLoading = document.getElementById('fileLoading');
    const loadedMessage = document.getElementById('loadedMessage');
    const loadedName = document.getElementById('loadedName');
    const statsDiv = document.getElementById('stats');
    const searchInput = document.getElementById('search');
    const searchFilter = document.querySelector('.search-filter');
    const filterToggle = document.getElementById('filterToggle');
    const toggleArrow = document.getElementById('toggleArrow');
    const toggleText = document.getElementById('toggleText');
    const filterOptions = document.getElementById('filterOptions');
    const actionsGroup = document.getElementById('actionsGroup');
    const resultCountDiv = document.getElementById('resultCount');
    const countNumber = document.getElementById('countNumber');
    const headerRow = document.getElementById('headerRow');
    const search = document.getElementById('search');

    // Eventos zona de carga
    ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.add('hover'); }));
    ['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.remove('hover'); }));
    dropzone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
    dropzone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));
    loadUrlBtn.addEventListener('click', () => {
      if (!urlInput.value) return alert('Introduce una URL o ruta');
      fetch(urlInput.value)
        .then(res => res.text())
        .then(txt => handleFile(new Blob([txt], { type: 'text/csv' }), urlInput.value))
        .catch(err => alert('Error: ' + err));
    });

    // Toggle filtros
    filterToggle.addEventListener('click', () => {
      const open = filterOptions.style.display === 'block';
      filterOptions.style.display = open ? 'none' : 'block';
      toggleArrow.textContent = open ? '▸' : '▾';
      toggleText.textContent = open ? 'Mostrar filtros' : 'Ocultar filtros';
    });

    function handleFile(file, nameOverride) {
      const name = nameOverride || file.name;
      isDefault = name.includes('-default');
      fileLoading.style.display = 'none';
      loadedMessage.style.display = 'block';
      search.style.display = 'block';
      loadedName.textContent = name;
      statsDiv.style.display = isDefault ? 'none' : 'block';
      searchFilter.style.display = isDefault ? 'none' : 'flex';
      filterToggle.style.display = isDefault ? 'none' : 'block';
      filterOptions.style.display = 'none';
      actionsGroup.style.display = isDefault ? 'none' : 'flex';
      resultCountDiv.style.display = isDefault ? 'none' : 'block';
      document.querySelector('.table-container').style.display = 'block';
      const headers = isDefault ? ['Producto','Apps','Proxies','Descartable','Razón'] : ['App','Developer','APIProduct','Proxy','KVM','Target'];
      setupHeader(headers);
      Papa.parse(file, { header: true, delimiter: ';', skipEmptyLines: true, complete: res => { data = res.data; init(); }});
    }

    function setupHeader(cols) {
      headerRow.innerHTML = '';
      cols.forEach(c => { const th = document.createElement('th'); th.textContent = c; headerRow.appendChild(th); });
    }

    function init() {
      if (!isDefault) {
        const apps = new Set(data.map(r => r.App).filter(x => x)).size;
        const prods = new Set(data.map(r => r.APIProduct).filter(x => x)).size;
        const prox = new Set(data.map(r => r.Proxy).filter(x => x)).size;
        statsDiv.textContent = `Apps: ${apps} | Productos: ${prods} | Proxies: ${prox}`;
      }
      attachEvents();
      applyFilters();
    }

    function attachEvents() {
      searchInput.addEventListener('input', applyFilters);
      filterOptions.querySelectorAll('input[name=\"mode\"]').forEach(rb => rb.addEventListener('change', applyFilters));
      filterOptions.querySelectorAll('input[type=\"checkbox\"]').forEach(cb => cb.addEventListener('change', applyFilters));
    }

    function applyFilters() {
      const mode = document.querySelector('input[name=\"mode\"]:checked').value;
      let temp = data.filter(r => {
        if (mode === 'prodSinApp') return !(r.App||'').trim() && (r.APIProduct||'').trim();
        if (mode === 'proxySinProd') return !(r.APIProduct||'').trim() && (r.Proxy||'').trim();
        return true;
      });
      const term = (searchInput.value||'').toLowerCase();
      const cols = [];
      document.getElementById('chkApp').checked && cols.push('App');
      document.getElementById('chkDev').checked && cols.push('Developer');
      document.getElementById('chkProd').checked && cols.push('APIProduct');
      document.getElementById('chkProxy').checked && cols.push('Proxy');
      document.getElementById('chkKVM').checked && cols.push('KVM');
      document.getElementById('chkTarget').checked && cols.push('Target');
      filtered = temp.filter(r => cols.some(c => (r[c]||'').toLowerCase().includes(term)));
      countNumber.textContent = filtered.length;
      renderTable();
    }

    function renderTable() {
      const tbody = document.querySelector('#inventoryTable tbody'); tbody.innerHTML = '';
      if (isDefault) {
        filtered.forEach(r => {
          const tr = document.createElement('tr');
          ['Producto','Apps','Proxies','Descartable','Razón'].forEach(c => {
            const td = document.createElement('td'); td.textContent = r[c]||''; tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      } else {
        [...new Set(filtered.map(r => r.App))].forEach(app => {
          const rows = filtered.filter(r => r.App === app);
          let first = true;
          rows.forEach(r => {
            const tr = document.createElement('tr');
            if (first) {
              ['App','Developer'].forEach(c => {
                const td = document.createElement('td'); td.rowSpan = rows.length; td.textContent = r[c]||''; tr.appendChild(td);
              }); first = false;
            }
            ['APIProduct','Proxy','KVM','Target'].forEach(c => {
              const td = document.createElement('td'); td.textContent = r[c]||''; tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        });
      }
    }

    function copySetup() {
      const btn = document.getElementById('copyBtn'); btn.onclick = async () => {
        const tbl = document.getElementById('inventoryTable');
        const html = tbl.outerHTML;
        let text = '';
        tbl.querySelectorAll('tr').forEach(row => { text += Array.from(row.children).map(td => td.innerText).join('\t') + '\n'; });
        try {
          await navigator.clipboard.write([new ClipboardItem({ 'text/html': new Blob([html], { type: 'text/html' }), 'text/plain': new Blob([text], { type: 'text/plain' }) })]);
          alert('Tabla copiada con formato');
        } catch {
          navigator.clipboard.writeText(text).then(() => alert('Tabla copiada como texto'));
        }
      };
    }

    function exportSetup() {
      const btn = document.getElementById('exportBtn'); btn.onclick = () => {
        const hdr = isDefault ? ['Producto','Apps','Proxies','Descartable','Razón'] : ['App','Developer','APIProduct','Proxy','KVM','Target'];
        const rows = filtered.map(r => hdr.map(c => r[c]||''));
        const csv = [hdr, ...rows].map(a => a.join(';')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
        link.download = isDefault ? 'productos_default.csv' : 'inventario.csv'; link.click();
      };
    }

    // Inicializar copia y export al cargar el script
    copySetup();
    exportSetup();
  </script>
</body>
</html>