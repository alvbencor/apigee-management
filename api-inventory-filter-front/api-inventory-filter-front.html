<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario de APIs</title>
  <style>
    body {
      font-family: monospace;
      margin: 2rem auto;
      width: 80%;
      background-color: #3e5248;
      color: beige;
    }
    h1 {
      font-family: monospace;
      color: beige;
      margin: 0;
    }

    /* ---------------------
       Encabezado principal
       --------------------- */
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    .header-container .info {
      text-align: right;
      font-size: 0.8rem;
      color: #fbf3a3;
      line-height: 1.4;
    }
    .header-container .info .stats {
      display: block;
      margin-bottom: 0.2rem;
    }
    .header-container .info .loaded {
      display: none;
      color: #5d9c79;
      font-size: 0.8rem;
    }

    /* ---------------------
       Zona de carga inicial
       --------------------- */
    .file-loading {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    .dropzone {
      border: 2px dashed #afe2b1;
      width: 17rem;
      height: calc(2.5rem * 2 + 0.5rem);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #afe2b1;
      cursor: pointer;
    }
    .dropzone.hover {
      background-color: #52675b;
    }
    .url-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .url-group input,
    .url-group button {
      height: 2.5rem;
      padding: 0 0.5rem;
      border: none;
      border-radius: 4px;
      font-family: monospace;
    }
    .url-group input {
      background: #52675b;
      color: beige;
      width: 17rem;
    }
    .url-group input::placeholder {

      color: beige;
      width: 17rem;
    }
    .url-group button {
      background: #fffed0;
      color: #3c3f3f;
      cursor: pointer;
      text-align: left;
      width: 9rem;

    }

    /* --------------------------------------------
       Ocultar inicialmente ciertos bloques hasta
       que se cargue el CSV:
       - stats, “Archivo cargado”
       - buscador principal (#searchFilter)
       - filtros (#filterOptions)
       - acciones (#actionsContainer)
       - tabla (#inventoryTable)
       -------------------------------------------- */
    #stats,
    .loaded,
    #searchFilter,
    #filterOptions,
    #actionsContainer,
    .table-container {
      display: none;
    }

    /* ---------------------------
       Buscador principal + toggle
       --------------------------- */
    .search-filter {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
      margin-right: 1rem;
    }
    #searchGroup input {
      width: 100%;
      max-width: 30rem;
      padding: 0.5rem;
      border: none;
      border-radius: 4px;
      background: #52675b;
      color: beige;
      font-family: monospace;
    }
    /* Placeholder en monospace y amarillo pálido */
    #search::placeholder {
      font-family: monospace;
      color: #b4b083;
    }
    #search {
      display: block;
      margin-right: 1rem;
      font-family: monospace;
    }
    .filter-toggle {
      cursor: pointer;
      font-family: monospace;
      margin-left: 1rem;
    }
    .filter-toggle span {
      user-select: none;
      color: #fbf3a3;
    }

    /* ---------------------
       Filtros (fieldsets)
       --------------------- */
    #filterOptions {
      margin: 1rem 0;
      font-family: monospace;
      display: flex;
      gap: 1rem;
      display: none; /* oculto hasta toggle */
    }
    fieldset {
      border: 1px solid #afe2b1;
      padding: 1rem;
      flex: 1;
    }
    legend {
      color: #fbf3a3;
      font-weight: bold;
    }
    #filterOptions .radios,
    #filterOptions .checkboxes {
      margin-top: 0.5rem;
    }
    #filterOptions label {
      margin-right: 1rem;
    }
    #stats { color: #add372; }

    /* ==============================
       ESTILOS PARA “BOTONES-RADIO”
       ============================== */
    .radio-btn input[type="radio"] {
      display: none;
    }
    .radio-btn span {
      display: inline-block;
      padding: 0.4rem;
      border-radius:0px;
      background-color: #85ecb2;
      opacity: 0.5;
      cursor: pointer;
      font-family: monospace;
      font-size: 0.7rem;
      user-select: none;
      transition: opacity 0.2s ease;
      margin-bottom: .7rem;
      color: #3c3f3f;
    }
    .radio-btn input[type="radio"]:checked + span {
      opacity: 1;
    }
    .radio-btn span:hover {
      opacity: 0.8;
    }

    /* ==============================
       ESTILOS PARA “BOTONES-CHECKBOX”
       ============================== */
    .checkbox-btn input[type="checkbox"] {
      display: none;
    }
    .checkbox-btn span {
      display: inline-block;
      padding: 0.4rem;
      border-radius:0px;
      background-color: #85ecb2;
      opacity: 0.5;
      cursor: pointer;
      font-family: monospace;
      font-size: 0.7rem;
      user-select: none;
      transition: opacity 0.2s ease;
      margin-bottom: .7rem;
      color: #3c3f3f;
    }
    .checkbox-btn input[type="checkbox"]:checked + span {
      opacity: 1;
    }
    .checkbox-btn span:hover {
      opacity: 0.8;
    }

    /* ==============================
       ESTILOS PARA BOTONES “Select All” /
       “Deselect All”
       ============================== */
    .checkbox-btn-small {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      margin-bottom: 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      color: #3c3f3f;
      border: none;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }
    .checkbox-btn-small:hover {
      opacity: 1;
    }

    /* -----------------------------------------------------
       Contenedor de “resultado de búsqueda” + botones
       ----------------------------------------------------- */
    #actionsContainer {
      display: none;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    /* Texto de resultados (izquierda) */
    #resultCount {
      font-size: 0.8rem;
      color: #cec78f;
      font-family: monospace;
    }
    /* Grupo de botones (derecha) */
    #buttonsGroup {
      display: flex;
      gap: 1rem;
    }
    .copy-btn {
      background-color: #fbf3a3;
      color: #3c3f3f;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
      font-size: 0.9rem;
    }
    .export-btn {
      background-color: #abfbb0;
      color: #3c3f3f;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
      font-size: 0.9rem;
    }

    /* -------------
       Tabla final
       ------------- */
    .table-container {
      max-width: 80vw;
      margin: 0 auto 2rem;
      overflow: auto;
      max-height: calc(100vh - 20rem);
    }
    table {
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.3rem;
      text-align: left;
      font-family: monospace;
      max-width: 15vw;
      word-wrap: break-word;
      word-break: break-all;
      overflow: hidden;
      position: relative;
    }
    th {
      background-color: #afe2b1;
      color: #3c3f3f;
      position: sticky;
      top: 0;
      z-index: 2;
      cursor: pointer;
    }
    .group-even td {
      background-color: #52675b;
    }
    .group-odd td {
      background-color: #3d5a4f;
    }
    .column-search-input {
      width: 90%;
      padding: 0.3rem;
      border: 1px solid #3c3f3f;
      border-radius: 4px;
      background: #52675b;
      color: beige;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <!-- ================================
       ENCABEZADO PRINCIPAL
       ================================
  -->
  <div class="header-container">
    <div>
      <h1>Inventario de APIs</h1>
    </div>
    <div class="info">
      <span id="stats" class="stats"></span>
      <span id="loadedMessage" class="loaded">
        Archivo cargado: <span id="loadedName"></span>
      </span>
    </div>
  </div>

  <!-- ================================
       ZONA DE CARGA INICIAL
       ================================
  -->
  <div class="file-loading" id="fileLoading">
    <div class="dropzone" id="dropzone">Arrastra tu CSV o haz clic</div>
    <div class="url-group" id="urlGroup">
      <input type="text" id="urlInput" placeholder="Introduce URL">
      <button id="loadUrlBtn">Cargar inventario</button>
    </div>
  </div>
  <input type="file" id="fileInput" accept=".csv" style="display: none;">

  <!-- ================================
       BUSCADOR PRINCIPAL + TOGGLE
       ================================
  -->
  <div class="search-filter" id="searchFilter">
    <div id="searchGroup">
      <input id="search" type="text" placeholder="Escribe para filtrar...">
    </div>
    <div class="filter-toggle" id="filterToggle">
      <span id="toggleArrow">▸</span>
      <span id="toggleText">Mostrar filtros</span>
    </div>
  </div>

  <!-- ================================
       FILTROS (OCULTOS HASTA TOGGLE)
       ================================
  -->
  <div id="filterOptions">
    <!-- Filtrado por producto -->
    <fieldset>
      <legend>Filtrado por producto</legend>
      <div class="radios">
        <label class="radio-btn">
          <input type="radio" name="mode" value="all" checked>
          <span>Todo</span>
        </label>
        <label class="radio-btn">
          <input type="radio" name="mode" value="prodSinApp">
          <span>Sólo productos sin app</span>
        </label>
        <label class="radio-btn">
          <input type="radio" name="mode" value="proxySinProd">
          <span>Sólo proxies sin producto</span>
        </label>
        <label class="radio-btn">
          <input type="radio" name="mode" value="productosHuerfanos">
          <span>Productos huérfanos</span>
        </label>
        <label class="radio-btn">
          <input type="radio" name="mode" value="productosDescartables">
          <span>Productos descartables</span>
        </label>
      </div>
    </fieldset>

    <!-- Filtrado por campo -->
    <fieldset>
      <legend>Filtrado por campo</legend>
      <div class="checkboxes">
        <label class="checkbox-btn">
          <input type="checkbox" id="chkApp" checked>
          <span>Apps</span>
        </label>
        <label class="checkbox-btn">
          <input type="checkbox" id="chkDev" checked>
          <span>Developers</span>
        </label>
        <label class="checkbox-btn">
          <input type="checkbox" id="chkProd" checked>
          <span>Productos</span>
        </label>
        <label class="checkbox-btn">
          <input type="checkbox" id="chkProxy" checked>
          <span>Proxies</span>
        </label>
        <label class="checkbox-btn">
          <input type="checkbox" id="chkKVM" checked>
          <span>KVM</span>
        </label>
        <label class="checkbox-btn">
          <input type="checkbox" id="chkTarget" checked>
          <span>Targets</span>
        </label>
      </div>
            <!-- Botones Select/Deselect pequeños -->
      <button id="btnSelectAll" class="checkbox-btn-small">Todos</button>
      <button id="btnDeselectAll" class="checkbox-btn-small">Limpiar</button>
 
    </fieldset>
  </div>

  <!-- ==================================================
       FILA DE “RESULTADO DE BÚSQUEDA” + BOTONES
       ==================================================
       (oculto hasta cargar el CSV)
       ==================================================
  -->
  <div id="actionsContainer">
    <div id="resultCount"></div>
    <div id="buttonsGroup">
      <button class="copy-btn" id="copyBtn">Copiar tabla</button>
      <button class="export-btn" id="exportBtn">Exportar a CSV</button>
    </div>
  </div>

  <!-- ================================
       TABLA FINAL (oculta al inicio)
       ================================
  -->
  <div class="table-container">
    <table id="inventoryTable">
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Papaparse (para parsear CSVs en el navegador) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let data = [], filtered = [], isDefault = false;

    // Mapa de columna → ID de checkbox
    const columnToCheckboxId = {
      App: "chkApp",
      Developer: "chkDev",
      APIProduct: "chkProd",
      Proxy: "chkProxy",
      KVM: "chkKVM",
      Target: "chkTarget"
    };
    const columnFilters = {};

    // Referencias a elementos del DOM
    const dropzone         = document.getElementById("dropzone");
    const fileInput        = document.getElementById("fileInput");
    const urlInput         = document.getElementById("urlInput");
    const loadUrlBtn       = document.getElementById("loadUrlBtn");
    const fileLoading      = document.getElementById("fileLoading");
    const loadedMessage    = document.getElementById("loadedMessage");
    const loadedName       = document.getElementById("loadedName");
    const statsDiv         = document.getElementById("stats");
    const searchFilter     = document.getElementById("searchFilter");
    const searchInput      = document.getElementById("search");
    const filterToggle     = document.getElementById("filterToggle");
    const toggleArrow      = document.getElementById("toggleArrow");
    const toggleText       = document.getElementById("toggleText");
    const filterOptions    = document.getElementById("filterOptions");
    const actionsContainer = document.getElementById("actionsContainer");
    const resultCountDiv   = document.getElementById("resultCount");
    const headerRow        = document.getElementById("headerRow");

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    function resetRadiosAndCheckboxes() {
      document.querySelector('input[name="mode"][value="all"]').checked = true;
      ["chkApp","chkDev","chkProd","chkProxy","chkKVM","chkTarget"].forEach(id => {
        document.getElementById(id).checked = true;
      });
    }

    function isAnyColumnFilterActive() {
      return Object.values(columnFilters).some(term => term && term.trim().length > 0);
    }

    function resetColumnFiltersUI() {
      for (const key in columnFilters) {
        columnFilters[key] = "";
      }
      Array.from(headerRow.children).forEach(th => {
        const colName = th.getAttribute("data-column-name");
        if (colName) {
          th.innerHTML = colName;
        }
      });
    }

    // ============================================
    // EVENTOS “Drag & Drop” Y CARGA DE ARCHIVO
    // ============================================
    ["dragenter", "dragover"].forEach(evt => {
      dropzone.addEventListener(evt, e => {
        e.preventDefault();
        dropzone.classList.add("hover");
      });
    });
    ["dragleave", "drop"].forEach(evt => {
      dropzone.addEventListener(evt, e => {
        e.preventDefault();
        dropzone.classList.remove("hover");
      });
    });
    dropzone.addEventListener("drop", e => handleFile(e.dataTransfer.files[0]));
    dropzone.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => handleFile(fileInput.files[0]));

    // ============================================
    // CARGAR CSV DESDE URL (fetch + Blob)
    // ============================================
    loadUrlBtn.addEventListener("click", () => {
      const url = urlInput.value.trim();
      if (!url) {
        alert("Introduce una URL");
        return;
      }
      fetch(url)
        .then(res => res.text())
        .then(txt => {
          handleFile(new Blob([txt], { type: "text/csv" }), url);
        })
        .catch(err => alert("Error: " + err));
    });

    // ============================================
    // TOGGLE “Mostrar filtros” / “Ocultar filtros”
    // ============================================
    filterToggle.addEventListener("click", () => {
      const abierto = filterOptions.style.display === "flex";
      if (abierto) {
        resetRadiosAndCheckboxes();
        applyFilters();
      }
      filterOptions.style.display = abierto ? "none" : "flex";
      toggleArrow.textContent     = abierto ? "▸" : "▾";
      toggleText.textContent      = abierto ? "Mostrar filtros" : "Ocultar filtros";
    });

    // ============================================
    // MANEJO DE ARCHIVO CSV
    // ============================================
    function handleFile(file, nameOverride) {
      const name = nameOverride || file.name;
      isDefault = name.includes("-default");

      // 1) Ocultar “zona de carga”
      fileLoading.style.display      = "none";

      // 2) Mostrar buscador y acciones
      searchFilter.style.display     = "flex";
      actionsContainer.style.display = "flex";

      // 3) Rellenar “stats” y “Archivo cargado”
      loadedName.textContent        = name;
      loadedMessage.style.display   = "inline-block";
      statsDiv.style.display        = isDefault ? "none" : "block";

      // 4) Ocultar filtros, resetear valores y ocultar inputs en cabeceras
      filterOptions.style.display   = "none";
      toggleArrow.textContent       = "▸";
      toggleText.textContent        = "Mostrar filtros";
      resetRadiosAndCheckboxes();

      // 5) Mostrar tabla contenedor
      document.querySelector(".table-container").style.display = "block";

      // 6) Definir cabeceras
      const headers = isDefault
        ? ["Producto", "Apps", "Proxies", "Descartable", "Razón"]
        : ["App", "Developer", "APIProduct", "Proxy", "KVM", "Target"];

      setupHeader(headers);

      // 7) Parsear con PapaParse
      Papa.parse(file, {
        header: true,
        delimiter: ";",
        skipEmptyLines: true,
        complete: res => {
          data = res.data;
          init();
        }
      });
    }

    // ============================================
    // CONSTRUIR ENCABEZADOS DINÁMICOS
    // ============================================
    function setupHeader(cols) {
      headerRow.innerHTML = "";
      cols.forEach(col => {
        columnFilters[col] = "";
      });
      cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c;
        headerRow.appendChild(th);
        if (!isDefault) {
          th.addEventListener("click", () => activateColumnSearch(c, th));
        }
      });
    }

    // ============================================
    // INICIALIZACIÓN: ESTADÍSTICAS + EVENTOS
    // ============================================
    function init() {
      if (!isDefault) {
        const apps  = new Set(data.map(r => r.App).filter(x => x)).size;
        const prods = new Set(data.map(r => r.APIProduct).filter(x => x)).size;
        const prox  = new Set(data.map(r => r.Proxy).filter(x => x)).size;
        statsDiv.textContent =
          `${apps} ${apps === 1 ? "app" : "apps"} | ` +
          `${prods} ${prods === 1 ? "producto" : "productos"} | ` +
          `${prox} ${prox === 1 ? "proxy" : "proxies"}`;
      }
      attachEvents();
      applyFilters();
    }

    // ============================================
    // ASIGNAR EVENTOS
    // ============================================
    function attachEvents() {
      // Buscador global
      searchInput.addEventListener("input", () => {
        if (!isAnyColumnFilterActive()) {
          applyFilters();
        }
      });

      // Radios (filtrado por producto)
      filterOptions.querySelectorAll('input[name="mode"]').forEach(rb => {
        rb.addEventListener("change", () => {
          resetColumnFiltersUI();
          applyFilters();
        });
      });

      // Checkboxes (filtrado por campo)
      ["chkApp","chkDev","chkProd","chkProxy","chkKVM","chkTarget"].forEach(
        id => {
          document.getElementById(id).addEventListener("change", () => {
            resetColumnFiltersUI();
            applyFilters();
          });
        }
      );

      // Botones “Seleccionar todos” / “Deseleccionar todos”
      document.getElementById("btnSelectAll").addEventListener("click", () => {
        ["chkApp","chkDev","chkProd","chkProxy","chkKVM","chkTarget"].forEach(
          id => {
            document.getElementById(id).checked = true;
          }
        );
        resetColumnFiltersUI();
        applyFilters();
      });
      document.getElementById("btnDeselectAll").addEventListener("click", () => {
        ["chkApp","chkDev","chkProd","chkProxy","chkKVM","chkTarget"].forEach(
          id => {
            document.getElementById(id).checked = false;
          }
        );
        resetColumnFiltersUI();
        applyFilters();
      });
    }

    // ============================================
    // ABRIR INPUT DE BÚSQUEDA EN CABECERA
    // ============================================
    function activateColumnSearch(columnName, thElement) {
      // 1) Cerrar inputs en otras cabeceras
      Array.from(headerRow.children).forEach(th => {
        if (th !== thElement) {
          const almacen = th.getAttribute("data-column-name");
          if (almacen) th.innerHTML = almacen;
        }
      });
      // 2) Limpiar filtros de columna
      for (const key in columnFilters) columnFilters[key] = "";
      // 3) Borrar buscador principal
      searchInput.value = "";

      // 4) Marcar checkbox de la columna
      const checkboxId = columnToCheckboxId[columnName];
      if (checkboxId) {
        const cb = document.getElementById(checkboxId);
        if (cb && !cb.checked) cb.checked = true;
      }

      // 5) Si ya hay input aquí, salir
      if (thElement.querySelector("input")) return;

      // 6) Crear input
      thElement.setAttribute("data-column-name", columnName);
      thElement.innerHTML = "";
      const input = document.createElement("input");
      input.type = "text";
      input.className = "column-search-input";
      input.placeholder = `Buscar en ${columnName}...`;
      thElement.appendChild(input);
      input.focus();

      // 7) Filtrar al escribir
      input.addEventListener("input", () => {
        columnFilters[columnName] = input.value.toLowerCase();
        applyFilters();
      });
      // 8) Restaurar cabecera al perder foco
      input.addEventListener("blur", () => {
        columnFilters[columnName] = "";
        thElement.innerHTML = columnName;
        applyFilters();
      });
    }

    // ============================================
    // APLICAR FILTROS
    // ============================================
    function applyFilters() {
      const mode = document.querySelector('input[name="mode"]:checked').value;

      if (mode === "productosHuerfanos") {
        const productToProxies = {};
        data.forEach(row => {
          const prod = (row.APIProduct || "").trim();
          const prox = (row.Proxy || "").trim();
          if (!prod) return;
          if (!productToProxies[prod]) productToProxies[prod] = new Set();
          if (prox) productToProxies[prod].add(prox);
        });
        const orphanProducts = new Set();
        Object.keys(productToProxies).forEach(prod => {
          if (productToProxies[prod].size === 0) orphanProducts.add(prod);
        });
        filtered = data.filter(r =>
          orphanProducts.has((r.APIProduct || "").trim())
        );

      } else if (mode === "productosDescartables") {
        filtered = data.filter(r => {
          const prod = (r.APIProduct || "").trim();
          const prox = (r.Proxy || "").trim();
          const app  = (r.App || "").trim();
          if (app === "" && prod.endsWith("_default")) {
            const base = prod.slice(0, prod.length - "_default".length);
            return prox === base;
          }
          return false;
        });

      } else if (isAnyColumnFilterActive()) {
        filtered = data.filter(row => {
          for (const col in columnFilters) {
            const term = columnFilters[col];
            if (term && term.trim().length > 0) {
              const cellVal = (row[col] || "").toLowerCase();
              if (!cellVal.includes(term)) return false;
            }
          }
          if (mode === "prodSinApp") {
            if ((row.App || "").trim() || !(row.APIProduct || "").trim()) return false;
          } else if (mode === "proxySinProd") {
            if ((row.APIProduct || "").trim() || !(row.Proxy || "").trim()) return false;
          }
          return true;
        });

      } else {
        let temp = data.slice();
        if (mode === "prodSinApp") {
          temp = temp.filter(r =>
            !(r.App || "").trim() && (r.APIProduct || "").trim()
          );
        } else if (mode === "proxySinProd") {
          temp = temp.filter(r =>
            !(r.APIProduct || "").trim() && (r.Proxy || "").trim()
          );
        }
        const term = (searchInput.value || "").toLowerCase();
        const cols = [];
        if (document.getElementById("chkApp").checked)    cols.push("App");
        if (document.getElementById("chkDev").checked)    cols.push("Developer");
        if (document.getElementById("chkProd").checked)   cols.push("APIProduct");
        if (document.getElementById("chkProxy").checked)  cols.push("Proxy");
        if (document.getElementById("chkKVM").checked)    cols.push("KVM");
        if (document.getElementById("chkTarget").checked) cols.push("Target");

        if (term) {
          filtered = temp.filter(r =>
            cols.some(c => (r[c] || "").toLowerCase().includes(term))
          );
        } else {
          filtered = temp.slice();
        }
      }

      // ---------------------------
      // Actualizar “Resultado de búsqueda” (valores únicos)
      // ---------------------------
      const counts = [];
      const uniqueApps = new Set(
        filtered.map(r => (r.App || "").trim()).filter(val => val.length > 0)
      );
      if (uniqueApps.size > 0) {
        counts.push(
          `${uniqueApps.size} ${uniqueApps.size === 1 ? "app" : "apps"}`
        );
      }
      const uniqueProds = new Set(
        filtered.map(r => (r.APIProduct || "").trim()).filter(val => val.length > 0)
      );
      if (uniqueProds.size > 0) {
        counts.push(
          `${uniqueProds.size} ${uniqueProds.size === 1 ? "producto" : "productos"}`
        );
      }
      const uniqueProxies = new Set(
        filtered.map(r => (r.Proxy || "").trim()).filter(val => val.length > 0)
      );
      if (uniqueProxies.size > 0) {
        counts.push(
          `${uniqueProxies.size} ${uniqueProxies.size === 1 ? "proxy" : "proxies"}`
        );
      }

      if (counts.length > 0) {
        resultCountDiv.textContent = `Resultado de búsqueda: ${counts.join(", ")}`;
      } else {
        resultCountDiv.textContent = "";
      }

      renderTable();
    }

    // ============================================
    // RENDERIZAR TABLA
    // ============================================
    function renderTable() {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "";

      if (isDefault) {
        filtered.forEach((r, idx) => {
          const tr = document.createElement("tr");
          tr.className = idx % 2 === 0 ? "group-even" : "group-odd";
          ["Producto", "Apps", "Proxies", "Descartable", "Razón"].forEach(c => {
            const td = document.createElement("td");
            td.textContent = r[c] || "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      } else {
        const appsUnicos = Array.from(new Set(filtered.map(r => r.App)));
        appsUnicos.forEach((app, appIdx) => {
          const rowsPorApp    = filtered.filter(r => r.App === app);
          const totalFilasApp = rowsPorApp.length;
          const groupClass    = appIdx % 2 === 0 ? "group-even" : "group-odd";
          let appRowStart     = true;

          const productos = Array.from(new Set(rowsPorApp.map(r => r.APIProduct)));
          productos.forEach(prod => {
            const rowsPorProducto = rowsPorApp.filter(r => r.APIProduct === prod);
            const filasProducto   = rowsPorProducto.length;

            rowsPorProducto.forEach((r, idxProducto) => {
              const tr = document.createElement("tr");
              tr.className = groupClass;

              if (appRowStart) {
                const tdApp = document.createElement("td");
                tdApp.rowSpan    = totalFilasApp;
                tdApp.textContent = r.App;
                tr.appendChild(tdApp);

                const tdDev = document.createElement("td");
                tdDev.rowSpan    = totalFilasApp;
                tdDev.textContent = r.Developer;
                tr.appendChild(tdDev);

                appRowStart = false;
              }

              if (idxProducto === 0) {
                const tdProd = document.createElement("td");
                tdProd.rowSpan    = filasProducto;
                tdProd.textContent = r.APIProduct;
                tr.appendChild(tdProd);
              }

              const proxyActual   = r.Proxy || "";
              const filasDeEsteProxy = rowsPorProducto.filter(x => (x.Proxy || "") === proxyActual);
              const idxEnFilasProxy  = filasDeEsteProxy.findIndex(x =>
                x.App === r.App &&
                x.APIProduct === r.APIProduct &&
                x.Proxy === r.Proxy &&
                x.KVM === r.KVM &&
                x.Target === r.Target
              );
              if (idxEnFilasProxy === 0) {
                const tdProxy = document.createElement("td");
                tdProxy.rowSpan    = filasDeEsteProxy.length;
                tdProxy.textContent = proxyActual;
                tr.appendChild(tdProxy);
              }

              const tdKVM = document.createElement("td");
              tdKVM.textContent = r.KVM || "";
              tr.appendChild(tdKVM);

              const tdTarget = document.createElement("td");
              tdTarget.textContent = r.Target || "";
              tr.appendChild(tdTarget);

              tbody.appendChild(tr);
            });
          });
        });
      }
    }

    // ============================================
    // COPIAR TABLA AL PORTAPAPELES
    // ============================================
    function copySetup() {
      const btn = document.getElementById("copyBtn");
      btn.onclick = async () => {
        const tbl  = document.getElementById("inventoryTable");
        const html = tbl.outerHTML;
        let text   = "";
        tbl.querySelectorAll("tr").forEach(row => {
          text += Array.from(row.children)
                        .map(td => td.innerText)
                        .join("\t") + "\n";
        });
        try {
          await navigator.clipboard.write([
            new ClipboardItem({
              "text/html": new Blob([html], { type: "text/html" }),
              "text/plain": new Blob([text], { type: "text/plain" })
            })
          ]);
          alert("Tabla copiada con formato");
        } catch {
          navigator.clipboard.writeText(text).then(() =>
            alert("Tabla copiada como texto")
          );
        }
      };
    }

    // ============================================
    // EXPORTAR “filtered” A CSV Y DESCARGAR
    // ============================================
    function exportSetup() {
      const btn = document.getElementById("exportBtn");
      btn.onclick = () => {
        const hdr = isDefault
          ? ["Producto", "Apps", "Proxies", "Descartable", "Razón"]
          : ["App", "Developer", "APIProduct", "Proxy", "KVM", "Target"];
        const rows = filtered.map(r => hdr.map(c => r[c] || ""));
        const csv  = [hdr, ...rows].map(a => a.join(";")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.href     = URL.createObjectURL(blob);
        link.download = isDefault ? "productos_default.csv" : "inventario.csv";
        link.click();
      };
    }

    // ============================================
    // INICIALIZAR COPIAR Y EXPORTAR
    // ============================================
    copySetup();
    exportSetup();
  </script>
</body>
</html>
